---
title: "EDA"
output: html_notebook
---

Read dataset


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r eda, message=FALSE, warning=FALSE, results='hide'}
library(tidyverse)
accidents <- read_csv("NYPD_Motor_Vehicle_Collisions.csv")
```

Look at data

```{r}
tail(accidents)

```

```{r}
str(accidents)
```
## Missing Quality Analysis


```{r}
library(skimr)
skimr::skim(accidents) %>% filter(stat == "missing") %>%
arrange(desc(value)) %>% select(variable, type, value) %>% mutate(percent = value/nrow(accidents))

```
```{r}
accidents <- accidents %>% mutate(VEHICLES_INVOLVED_GTE3 = 1 * !is.na(`CONTRIBUTING FACTOR VEHICLE 3`))
```


```{r}
accidents <- accidents %>% select(-c(`VEHICLE TYPE CODE 5`,`CONTRIBUTING FACTOR VEHICLE 5`,
                                     `VEHICLE TYPE CODE 4`,`CONTRIBUTING FACTOR VEHICLE 4`,
                                     `VEHICLE TYPE CODE 3`,`CONTRIBUTING FACTOR VEHICLE 3`,
                                     `OFF STREET NAME`))

```


```{r, fig.height=10, fig.width=10}
library(extracat)
visna(accidents)

```
```{r}
accidents <- accidents %>% 
  mutate(DATE2 = as.Date(DATE, format='%m/%d/%Y')) %>% 
  arrange(DATE2) %>% 
  mutate(YEAR = format(DATE2, "%Y"))
```

```{r}
accidents_missing <- accidents %>% 
  mutate(MISSING_BOROUGH=1*is.na(BOROUGH), 
         MISSING_CONTRIBUTION_INFO=1*is.na(`CONTRIBUTING FACTOR VEHICLE 1`)) %>%
  select(MISSING_BOROUGH, MISSING_CONTRIBUTION_INFO, YEAR, BOROUGH)

missing_borough_by_year <- accidents_missing %>%
  group_by(YEAR) %>% summarise(pc_missing_borough=mean(MISSING_BOROUGH))

missing_contrib_by_year <- accidents_missing %>%
  group_by(YEAR) %>% summarise(pc_missing_contrib=mean(MISSING_CONTRIBUTION_INFO))

missing_contrib_by_borough <- accidents_missing %>%
  group_by(BOROUGH) %>% summarise(pc_missing_contrib=mean(MISSING_CONTRIBUTION_INFO))

missing_borough_by_year
missing_contrib_by_year
missing_contrib_by_borough
```

```{r}
ggplot(data=missing_borough_by_year, aes(x=YEAR, y=pc_missing_borough)) + geom_col()
```

```{r}
ggplot(data=missing_contrib_by_year, aes(x=YEAR, y=pc_missing_contrib)) + geom_col()
```

```{r}
ggplot(data=missing_contrib_by_borough, aes(x=BOROUGH, y=pc_missing_contrib)) + geom_col()
```

```{r}

names(accidents)
```

```{r}
accidents_by_zipcode <- accidents %>% 
  group_by(`ZIP CODE`) %>% 
  summarise(NUMBER_OF_ACCIDENTS = n(), 
            NUMBER_OF_DEATHS = sum(`NUMBER OF PERSONS KILLED`), 
            NUMBER_OF_INJURIES = sum(`NUMBER OF PERSONS INJURED`))

```


```{r}

accidents_per_day <- accidents %>%
  group_by(DATE2, BOROUGH) %>%
  summarise(NUMBER_OF_ACCIDENTS=n(), 
            NUMBER_OF_DEATHS = sum(`NUMBER OF PERSONS KILLED`), 
            NUMBER_OF_INJURIES = sum(`NUMBER OF PERSONS INJURED`))# %>%
#  filter(NUMBER_OF_ACCIDENTS<400) # Remove one outlier point 

```

```{r}
ggplot(accidents_per_day, aes(x=DATE2, y=NUMBER_OF_ACCIDENTS)) + geom_line(aes(colour="Accidents")) +
  geom_smooth(method = "loess", span = .2, se = TRUE, show.legend = TRUE, aes(colour="Trend")) +
  scale_colour_manual(name="Legend", values=c("black", "blue")) +
  xlab("Time") + ylab("Number of Daily Accidents") +
  ggtitle("Daily Accidents") +
  theme(plot.title = element_text(hjust = 0.5))

```

```{r, fig.height=10, fig.width=8}

accidents_by_reason <- accidents %>%
  group_by(`CONTRIBUTING FACTOR VEHICLE 1`,`CONTRIBUTING FACTOR VEHICLE 2`) %>%
  summarise(NUMBER_OF_ACCIDENTS=n(), 
            NUMBER_OF_DEATHS = sum(`NUMBER OF PERSONS KILLED`))

ggplot(data=accidents_by_reason, aes(x=`CONTRIBUTING FACTOR VEHICLE 1`, y=NUMBER_OF_ACCIDENTS)) + geom_col() + coord_flip()

```


```{r, fig.height=10, fig.width=8}

accidents_by_timeofday <- accidents %>%
  mutate(HOUR = hour(TIME)) %>%
  group_by(HOUR, BOROUGH) %>%
  summarise(NUMBER_OF_ACCIDENTS=n(), 
            NUMBER_OF_DEATHS = sum(`NUMBER OF PERSONS KILLED`), 
            NUMBER_OF_INJURIES = sum(`NUMBER OF PERSONS INJURED`))# %>%
#  filter(NUMBER_OF_ACCIDENTS<400) # Remove one outlier point 

```

```{r, fig.height=6, fig.width=8}

ggplot(accidents_by_timeofday, aes(x=HOUR, weights=NUMBER_OF_ACCIDENTS)) +
  geom_histogram(binwidth = 1) +
  # geom_line(aes(colour="Accidents")) +
  geom_density() +
  scale_colour_manual(name="Legend", values=c("black", "blue")) +
  xlab("Time") + ylab("Number of Hourly Accidents") +
  ggtitle("Hourly Accidents") +
  theme(plot.title = element_text(hjust = 0.5))

```

The histogram for the hourly frequency of accidents is bimodal. The frequency peaks at around 9 am, and them later at around 5 pm when the frequency of accidents is the maximum.


```{r, fig.height=6, fig.width=8}

accidents_by_reason <- accidents %>%
  mutate(QUARTER = as.integer(hour(TIME)/6)) %>%
  group_by(`CONTRIBUTING FACTOR VEHICLE 1`,`CONTRIBUTING FACTOR VEHICLE 2`, `QUARTER`) %>%
  summarise(NUMBER_OF_ACCIDENTS=n(), 
            NUMBER_OF_DEATHS = sum(`NUMBER OF PERSONS KILLED`))

ggplot(data=accidents_by_reason, aes(x=`CONTRIBUTING FACTOR VEHICLE 1`, y=NUMBER_OF_ACCIDENTS)) + geom_col() + coord_flip() + facet_grid(.~QUARTER) +
theme(axis.text.x = element_text(angle = 90, hjust = 1))


```

There are a lot of unspecifioed reasons for accidents. Let's remove them to visualize the reasons better.


```{r, fig.height=6, fig.width=8}

t <- accidents_by_reason$`CONTRIBUTING FACTOR VEHICLE 1` == 'Unspecified'

accidents_by_reason_removed_unspecified <- accidents_by_reason[!t, ]

ggplot(data=accidents_by_reason_removed_unspecified, aes(x=`CONTRIBUTING FACTOR VEHICLE 1`, y=NUMBER_OF_ACCIDENTS)) + geom_col() + coord_flip() + facet_grid(.~QUARTER) +
theme(axis.text.x = element_text(angle = 90, hjust = 1))

```

The reasons for accidents are the same irrespective of the time of accident.


```{r, fig.height=6, fig.width=8}
ggplot(accidents_per_day, aes(x=DATE2, weights=NUMBER_OF_ACCIDENTS)) +
  geom_histogram(binwidth=30)+
  geom_density() +
  geom_vline(xintercept = as.Date("2014-01-01")) +
  scale_colour_manual(name="Legend", values=c("black", "blue")) +
  xlab("Time") + ylab("Number of Daily Accidents") +
  ggtitle("Daily Accidents") +
  theme(plot.title = element_text(hjust = 0.5))

```


```{r, fig.height=6, fig.width=8}

accidents_by_month <- accidents %>% 
  filter(DATE2 <= as.Date("2017-12-31") & DATE2 >= as.Date("2013-01-01")) %>%
  mutate(MONTH = format(DATE2, "%m"))

ggplot(accidents_by_month, aes(x=MONTH)) +
  geom_bar()+
  # geom_density() +
  scale_colour_manual(name="Legend", values=c("black", "blue")) +
  xlab("Time") + ylab("Number of Daily Accidents") +
  ggtitle("Daily Accidents") +
  theme(plot.title = element_text(hjust = 0.5))

```

Number of accidents is lowest in January - February, and maximum around May - June



------- To be edited ----------
```{r, fig.height=6, fig.width=8}

library(plotly)
df <- read.csv("https://raw.githubusercontent.com/plotly/datasets/master/2011_us_ag_exports.csv")
df$hover <- with(df, paste(state, '<br>', "Beef", beef, "Dairy", dairy, "<br>",
                           "Fruits", total.fruits, "Veggies", total.veggies,
                           "<br>", "Wheat", wheat, "Corn", corn))
# give state boundaries a white border
l <- list(color = toRGB("white"), width = 2)
# specify some map projection/options
g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)
 
plot_ly(df, z = ~total.exports, text = ~hover, locations = ~code, type = 'choropleth',
        locationmode = 'USA-states', color = ~total.exports, colors = 'Purples',
        marker = list(line = l), colorbar = list(title = "Millions USD"),
        filename="r-docs/usa-choropleth") %>%
  layout(title = '2011 US Agriculture Exports by State<br>(Hover for breakdown)', geo = g)

```




--END--

